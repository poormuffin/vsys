{"name":"character db","enabled":true,"description":"A character database","type":"group","id":1,"items":[{"type":"function","name":"onLoad","enabled":true,"id":2,"code":"//characterServerList = {};\n\n\ncdb = {};\ncdb.characterServerList = {};\ncdb.city_colours = {};\n\n//load up city colours\nif(get_variable(\"inverted_city_colours\")){\n   cdb.city_colours = get_variable(\"city_colours\");\n}else{\n    cdb.city_colours = {\"cyrene\":\"#008080\",\"targossas\":\"#ffffff\",\"eleusis\":\"#00ff00\",\"mhaldor\":\"#ff0000\",\"hashan\":\"#808000\",\"ashtan\":\"#800080\",\"(none)\":\"#c0c0c0\",\"(hidden)\":\"#c0c0c0\"};\n    cdb.inverted_city_colours = { \"#008080\": \"cyrene\", \"#ffffff\": \"targossas\", \"#00ff00\": \"eleusis\", \"#ff0000\": \"mhaldor\", \"#808000\": \"hashan\", \"#800080\": \"ashtan\", \"#c0c0c0\": \"(hidden)\" }\n    set_variable(\"city_colours\",cdb.city_colours);\n    set_variable(\"inverted_city_colours\",cdb.city_colours);\n}\n\n//get a single person from the API and add them to the DB\ngetCharacterByURI = function(uri) {\n\t$.getJSON( uri, function( data ) {\n        if (cdb.characterServerList[data.name]) {\n            cdb.characterServerList[data.name] = data;\n        }else{\n            cdb.characterServerList[data.name] = data;\n            $('<style id=\"roomliststyles\">#'+data.name.toLowerCase()+' { color: '+ cdb.city_colours[data.city] +'; }</style>').appendTo('head');\n        }\n\t});\n};\n\ngetCharacterByName = function(name) {\n    $.getJSON( \"https://api.achaea.com/characters/\" + name.toLowerCase() + \".json\", function ( data ) {\n        if (cdb.characterServerList[data.name]) {\n            cdb.characterServerList[data.name] = data;\n        }else{\n            cdb.characterServerList[data.name] = data;\n            $('<style id=\"roomliststyles\">#'+data.name.toLowerCase()+' { color: '+ cdb.city_colours[data.city] +'; }</style>').appendTo('head');\n        }\n\t});\n};\n              \n\n//Get full list online and call getCharacter on each to add them to the DB\ngetCharacterServerList = function(mode) {\n\t$.getJSON( \"https://api.achaea.com/characters.json\", function( data ) {\n\t\tif(mode == \"full\") {\n\t\t\tfor ( i = 0; i < data.characters.length; i++) {\n\t\t\t\tgetCharacterByURI(data.characters[i].uri);\n\t\t\t}\n\t\t\tsetTimeout(saveDB, 2000);\n            setTimeout(showDBUpdateString, 2000);\n\t\t}\n\t});\n};\n\n//update db function\nshowDBUpdateString = function() {\n    display_notice(\"Character DB updated \"+ getCharacterCount() + \" entries in database.\",\"yellow\");\n}\n\n//save the DB\nsaveDB = function() {\n    set_variable(\"characterDB\",cdb.characterServerList);\n}\n\n//Get a count of all characters in the DB\ngetCharacterCount = function() {\n\ti = 0;\n\tfor(var key in cdb.characterServerList) {\n\t\ti++;\n\t}\n\treturn i;\n};\n\n//add replaceAll function to String\nString.prototype.replaceAll = function(search, replacement) {\n    var target = this;\n    return target.replace(new RegExp(search, 'g'), replacement);\n};\n\n//Capitalize first letter of the string\nfixCaps = function(aword) {\n    return aword.charAt(0).toUpperCase() + aword.substr(1).toLowerCase();\n}\n\n//gather names from the database and apply colour to thier divs\nloadCSS = function() {\n    var someCSS = \"\";\n    for(var key in cdb.characterServerList) {\n        if (cdb.characterServerList[key]) {\n\t\t\tsomeCSS = someCSS + \"#\" + cdb.characterServerList[key].name.toLowerCase() + \" { color:\" + cdb.city_colours[cdb.characterServerList[key].city] + \";} \";\n        }\n\t}\n    console.log(someCSS);\n    $('<style id=\"roomliststyles\">'+ someCSS + '</style>').appendTo('head');\n}\n\n//MUTATIONS===================================================\n\n//Check if the list in who's online is updated and if so apply city colours\n\nloadMutations = function () {\n    var mutationObserver = new MutationObserver(function(mutations) {\n      mutations.forEach(function(mutation) {\n        if(mutation.addedNodes[0]) {\n            name = mutation.addedNodes[0].innerText;\n            if (cdb.characterServerList[name]) {\n                city = cdb.characterServerList[name].city;\n                mutation.addedNodes[0].style = \"padding: 2px 5px; cursor:pointer; color:\" + cdb.city_colours[city];\n            } else {\n                getCharacterByName(name.toLowerCase());\n            }\n        }\n      });\n    });\n\n    mutationObserver.observe($(\"#div_who_players\")[0], {\n      characterData: true,\n      childList: true,\n      subtree: true,\n    });\n}\n\n//END MUTATIONS===================================================\n\n//load DB if it exists, otherwise create a new one\nif(get_variable(\"characterDB\")) {\n\tcdb.characterServerList = get_variable(\"characterDB\");\n    getCharacterServerList(\"full\");\n    setTimeout(loadCSS, 2000);\n    setTimeout(loadMutations, 20000);\n} else {\n    getCharacterServerList(\"full\");\n    setTimeout(loadCSS, 2000);\n    setTimeout(loadMutations, 20000);\n}\n"},{"type":"function","name":"onGMCP","enabled":true,"id":11,"code":"//var characterServerList = get_variable(\"characterDB\");\n\nif (args.gmcp_method == \"Comm.Channel.Players\"){\n    for ( i = 0; i < args.gmcp_args.length; i++) {\n        if (cdb.characterServerList[args.gmcp_args[i].name]) {       \n        } else {\n            getCharacterByName(args.gmcp_args[i].name.toLowerCase());\n            console.log(\"getting \" + args.gmcp_args[i].name);\n        }\n    }\n}"},{"type":"alias","name":"cdb update","enabled":true,"id":3,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//Enter the script here\n\ngetCharacterServerList(\"full\");"}],"text":"cdb update"},{"type":"alias","name":"","enabled":true,"id":4,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"function","fn":"onLoad"}],"text":"call onload"},{"type":"alias","name":"cdb city","enabled":true,"id":5,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"name = fixCaps(args[1]);\n\ndisplay_notice(fixCaps(cdb.characterServerList[name].city));"}],"text":"cdb city (.*)"},{"type":"alias","name":"cdb citizens","enabled":true,"id":6,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//var characterServerList = get_variable(\"characterDB\");\nvar findInCity = args[1].toLowerCase();\n\nvar inCity = \"\";\nvar i = 0;\n\nfor(var key in cdb.characterServerList) {\n    if(cdb.characterServerList[key].city == findInCity) {\n        inCity = inCity + \", \" + cdb.characterServerList[key].name;\n        i++;\n    }\n}\n//display_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(findInCity),\"yellow\")\n//display_notice(inCity.substr(2),\"yellow\");\n\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'></br>\" + Array(findInCity.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'><span style='color: \" + cdb.city_colours[findInCity] + \"'>\"+fixCaps(findInCity)+\"<span style='color:#808000'> - \" + i + \"</span></span></div>\");\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'>\" + Array(findInCity.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'>\" + inCity.substr(2) + \"</div>\");"}],"text":"cdb citizens (.*)"},{"type":"alias","name":"cdb class","enabled":true,"id":7,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//var characterServerList = get_variable(\"characterDB\");\nvar findInClass = args[1].toLowerCase();\n\nvar inClass = \"\";\nvar i = 0;\n\nfor(var key in cdb.characterServerList) {\n    if(cdb.characterServerList[key].class == findInClass) {\n        inClass = inClass + \", \" + cdb.characterServerList[key].name;\n        i++;\n    }\n}\n//display_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(findInClass),\"yellow\")\n//display_notice(inClass.substr(2),\"yellow\");\n\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'></br>\" + Array(findInClass.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'>\"+fixCaps(findInClass)+\"<span style='color:#808000'> - \" + i + \"</span></div>\");\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'>\" + Array(findInClass.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'>\" + inClass.substr(2) + \"</div>\");"}],"text":"cdb class (.*)"},{"type":"alias","name":"cdb whois","enabled":true,"id":8,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//ow_Write(\"#output_main\",\"<div class='line'><a class='mxp_send' href='AB DEVOTION HELLSIGHT' style='color: #00dd00'>Hellsight</a></div>\");\n//var characterServerList = get_variable(\"characterDB\");\nvar city_colours = get_variable(\"city_colours\");\nvar name = \"\"+fixCaps(args[1]);\n\nif(cdb.characterServerList[name]) {\n\n    var fullName = cdb.characterServerList[name].fullname;\n\tvar city = cdb.characterServerList[name].city;\n\tvar aclass = cdb.characterServerList[name].class;\n\tvar house = cdb.characterServerList[name].house;\n\tvar level = cdb.characterServerList[name].level;\n\tvar rank = cdb.characterServerList[name].xp_rank;\n\tvar player_kills = cdb.characterServerList[name].player_kills;\n\n    ow_Write(\"#output_main\",\"<div class='mono'></br>\" + Array(fullName.length + 1).join(\"=\") + \"</div>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #808000'>\"+fullName+\"</span></div>\");\n    ow_Write(\"#output_main\",\"<div class='mono'>\" + Array(fullName.length + 1).join(\"=\") + \"</div>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>City:  <span style='color: \" + cdb.city_colours[city] + \"'>\" + fixCaps(city) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Level: <span style='color: #808000'>\" + Array(8).join(\" \") + level + \"</span></span></span></span>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>Class: <span style='color: #808000'>\" + fixCaps(aclass) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Rank: <span style='color: #808000'>\" + Array(9).join(\" \") + rank + \"</span></span></span></span>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>House: <span style='color: #808000'>\" + fixCaps(house) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Player Kills: <span style='color: #808000'>\" + player_kills + \"</span></span></span></span>\");\n    ow_Write(\"#output_main\",\"<div class='mono'></div>\");\n}else{\n    display_notice(\"No \" + name + \" in DB, fetching try again in 1 second\",\"yellow\")\n    getCharacterByName(name);\n}"}],"text":"cdb whois (.*)"},{"type":"alias","name":"cdb house","enabled":true,"id":9,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//var characterServerList = get_variable(\"characterDB\");\nvar findInHouse = args[1].toLowerCase();\n\nvar inHouse = \"\";\nvar i = 0;\n\nfor(var key in cdb.characterServerList) {\n    if(cdb.characterServerList[key].house == findInHouse) {\n        inHouse = inHouse + \", \" + cdb.characterServerList[key].name;\n        i++;\n    }\n}\n\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'></br>\" + Array(findInHouse.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'>\"+fixCaps(findInHouse)+\"<span style='color:#808000'> - \" + i + \"</span></div>\");\now_Write(\"#output_main\",\"<div class='mono' style='color: #808000'>\" + Array(findInHouse.length + i.toString().length + 4).join(\"=\") + \"</div>\");\now_Write(\"#output_main\",\"<div class='mono'>\" + inHouse.substr(2) + \"</div>\");"}],"text":"cdb house (.*)"},{"type":"alias","name":"cdb stats","enabled":true,"id":10,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"ow_Write(\"#output_main\",\"<table><tr id='cdbcityrow'></tr><tr id='cdbpeoplerow'></tr></table>\");"},{"action":"wait","seconds":"0","milliseconds":"100"},{"action":"script","script":"var cities = [];\nvar i = 0;\n\nfor(var key in cdb.characterServerList) {\n    if(cdb.characterServerList[key].city) {\n\t\tcities.push(cdb.characterServerList[key].city);\n    \ti++;\n\t}\n}\ncities = [...new Set(cities)];\n\ncities.forEach(function(element) {\n  \tvar inCity = \"\";\n\tvar i = 0;\n    $(\"tr#cdbcityrow\").last().append(\"<td>\"+element+\"</tr>\");\n\n\tfor(var key in cdb.characterServerList) {\n    \tif(cdb.characterServerList[key].city == element) {\n        \tinCity = inCity + \", \" + cdb.characterServerList[key].name;\n            i++;\n    \t}\n\t}\n    \n\t//display_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(element),\"yellow\")\n\t//display_notice(inCity.substr(2),\"yellow\");\n    \n    ow_Write(\"#output_main\",\"<div class='mono' style='color: #808000'></br>\" + Array(element.length + i.toString().length + 4).join(\"=\") + \"</div>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #808000'>\"+fixCaps(element)+\" - \" + i + \"</span></div>\");\n    ow_Write(\"#output_main\",\"<div class='mono' style='color: #808000'>\" + Array(element.length + i.toString().length + 4).join(\"=\") + \"</div>\");\n    ow_Write(\"#output_main\",\"<div class='mono'>\" + inCity.substr(2) + \"</div>\");\n});"}],"text":"cdb stats"}]}