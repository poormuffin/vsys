{"name":"character db","enabled":true,"description":"A character database","type":"group","id":1,"items":[{"type":"function","name":"onLoad","enabled":true,"id":2,"code":"var characterServerList = [];\nvar city_colours;\n\n//load up city colours\nif(get_variable(\"city_colours\")){\n   city_colours = get_variable(\"city_colours\");\n}else{\n    city_colours = {\"cyrene\":\"#008080\",\"targossas\":\"#ffffff\",\"eleusis\":\"#00ff00\",\"mhaldor\":\"#ff0000\",\"hashan\":\"#808000\",\"ashtan\":\"#800080\",\"(none)\":\"#c0c0c0\",\"(hidden)\":\"#c0c0c0\"};\n    set_variable(\"city_colours\",city_colours);\n}\n\n//supposed to load the DB however it is not persisting between sessions currently\nif(get_variable(\"characterDB\")) {\n\tcharacterServerList = get_variable(\"characterDB\");\n    display_notice(\"Character DB loaded\",\"yellow\");\n    getCharacterServerList(\"full\");\n} else {\n\tdisplay_notice(\"Character DB loaded\",\"yellow\");\n    getCharacterServerList(\"full\");\n}\n\n//Get full list online and call getCharacter on each to add them to the DB\ngetCharacterServerList = function(mode) {\n\t$.getJSON( \"https://api.achaea.com/characters.json\", function( data ) {\n\t\tif(mode == \"full\") {\n\t\t\tfor ( i = 0; i < data.characters.length; i++) {\n\t\t\t\tgetCharacter(data.characters[i].uri);\n\t\t\t}\n\t\t\tsetTimeout(saveDB, 2000);\n            setTimeout(showDBUpdateString, 2000);\n\t\t}\n\t});\n};\n\n//get a single person from the API and add them to the DB\ngetCharacter = function(uri) {\n\t$.getJSON( uri, function( data ) {\n        if (characterServerList[data.name]) {\n            characterServerList[data.name] = data;\n        }else{\n            characterServerList[data.name] = data;\n            $('<style id=\"roomliststyles\">#'+data.name.toLowerCase()+' { color: '+ city_colours[data.city] +'; }</style>').appendTo('head');\n        }\n\t});\n};\n\n//update db function\nshowDBUpdateString = function() {\n    display_notice(\"Character DB updated \"+ getCharacterCount() + \" entries in database.\",\"yellow\");\n}\n\n//supposed to save the DB however again not really persisting between sessions\nsaveDB = function() {\n    set_variable(\"characterDB\",characterServerList);\n}\n\n//Get a count of all characters in the DB\ngetCharacterCount = function() {\n\ti = 0;\n\tfor(var key in characterServerList) {\n\t\ti++;\n\t}\n\treturn i;\n};\n\n//add replaceAll function to String\nString.prototype.replaceAll = function(search, replacement) {\n    var target = this;\n    return target.replace(new RegExp(search, 'g'), replacement);\n};\n\n//Capitalize first letter of the string\nfixCaps = function(aword) {\n    return aword.charAt(0).toUpperCase() + aword.substr(1).toLowerCase();\n}\n\n\n//MUTATIONS===================================================\n\n//Check if the list in who's online is update and if so apply city colours\n//disconnect any previous mutation observers (used in testing/building)\n\n\nvar mutationObserver = new MutationObserver(function(mutations) {\n  mutations.forEach(function(mutation) {\n\tif(mutation.addedNodes[0]) {\n\t\tname = mutation.addedNodes[0].innerText;\n\t\tif (characterServerList[name]) {\n\t\t\tcity = characterServerList[name].city;\n\t\t\tmutation.addedNodes[0].style = \"padding: 2px 5px; cursor:pointer; color:\" + city_colours[city];\n\t\t} else {\n            getCharacter(name.toLowerCase());\n        }\n\t}\n  });\n});\n\nmutationObserver.observe($(\"#div_who_players\")[0], {\n  characterData: true,\n  childList: true,\n  subtree: true,\n});\n\n//END MUTATIONS==================================================="},{"type":"function","name":"onGMCP","enabled":true,"id":11,"code":"var characterServerList = get_variable(\"characterDB\");\n\nif (args.gmcp_method == \"Comm.Channel.Players\"){\n    for ( i = 0; i < args.gmcp_args.length; i++) {\n        if (characterServerList[args.gmcp_args[i].name]) {       \n        } else {\n            getCharacter(\"https://api.achaea.com/characters/\" + args.gmcp_args[i].name.toLowerCase() + \".json\");\n            //console.log(\"getting \" + args.gmcp_args[i].name);\n        }\n    }\n}"},{"type":"alias","name":"cdb update","enabled":true,"id":3,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//Enter the script here\n\ngetCharacterServerList(\"full\");"}],"text":"cdb update"},{"type":"alias","name":"","enabled":true,"id":4,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"function","fn":"onLoad"}],"text":"call onload"},{"type":"alias","name":"cbd city","enabled":true,"id":5,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//Enter the script here\nvar characterServerList = get_variable(\"characterDB\");\n\ndisplay_notice(fixCaps(characterServerList[fixCaps(args[1])].city));"}],"text":"cbd city (.*)"},{"type":"alias","name":"cdb citizens","enabled":true,"id":6,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"var characterServerList = get_variable(\"characterDB\");\nvar findInCity = args[1].toLowerCase();\n\nvar inCity = \"\";\nvar i = 0;\n\nfor(var key in characterServerList) {\n    if(characterServerList[key].city == findInCity) {\n        inCity = inCity + \", \" + characterServerList[key].name;\n        i++;\n    }\n}\ndisplay_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(findInCity),\"yellow\")\ndisplay_notice(inCity.substr(2),\"yellow\");"}],"text":"cdb citizens (.*)"},{"type":"alias","name":"cdb class","enabled":true,"id":7,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"var characterServerList = get_variable(\"characterDB\");\nvar findInClass = args[1].toLowerCase();\n\nvar inClass = \"\";\nvar i = 0;\n\nfor(var key in characterServerList) {\n    if(characterServerList[key].class == findInClass) {\n        inClass = inClass + \", \" + characterServerList[key].name;\n        i++;\n    }\n}\ndisplay_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(findInClass),\"yellow\")\ndisplay_notice(inClass.substr(2),\"yellow\");"}],"text":"cdb class (.*)"},{"type":"alias","name":"cdb whois","enabled":true,"id":8,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"//ow_Write(\"#output_main\",\"<div class='line'><a class='mxp_send' href='AB DEVOTION HELLSIGHT' style='color: #00dd00'>Hellsight</a></div>\");\nvar characterServerList = get_variable(\"characterDB\");\nvar name = \"\"+fixCaps(args[1]);\nif(characterServerList[name]) {\n\n    var fullName = characterServerList[name].fullname;\n\tvar city = characterServerList[name].city;\n\tvar aclass = characterServerList[name].class;\n\tvar house = characterServerList[name].house;\n\tvar level = characterServerList[name].level;\n\tvar rank = characterServerList[name].xp_rank;\n\tvar player_kills = characterServerList[name].player_kills;\n\n    ow_Write(\"#output_main\",\"<div class='mono'></br>\" + Array(fullName.length + 1).join(\"=\") + \"</div>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #808000'>\"+fullName+\"</span></div>\");\n    ow_Write(\"#output_main\",\"<div class='mono'>\" + Array(fullName.length + 1).join(\"=\") + \"</div>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>City:  <span style='color: \" + city_colours[city] + \"'>\" + fixCaps(city) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Level: <span style='color: #808000'>\" + Array(8).join(\" \") + level + \"</span></span></span></span>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>Class: <span style='color: #808000'>\" + fixCaps(aclass) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Rank: <span style='color: #808000'>\" + Array(9).join(\" \") + rank + \"</span></span></span></span>\");\n\tow_Write(\"#output_main\",\"<div class='mono'><span style='color: #aaaaaa'>House: <span style='color: #808000'>\" + fixCaps(house) + \"<span style='position: absolute;left: 400px;color: #aaaaaa'>Player Kills: <span style='color: #808000'>\" + player_kills + \"</span></span></span></span>\");\n    ow_Write(\"#output_main\",\"<div class='mono'></div>\");\n}else{\n    display_notice(\"No \" + name + \" in DB, fetching try again in 1 second\",\"yellow\")\n    getCharacter(\"https://api.achaea.com/characters/\" + name + \".json\");\n}"}],"text":"cdb whois (.*)"},{"type":"alias","name":"cdb house","enabled":true,"id":9,"matching":"regexp","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"var characterServerList = get_variable(\"characterDB\");\nvar findInHouse = args[1].toLowerCase();\n\nvar inHouse = \"\";\nvar i = 0;\n\nfor(var key in characterServerList) {\n    if(characterServerList[key].house == findInHouse) {\n        inHouse = inHouse + \", \" + characterServerList[key].name;\n        i++;\n    }\n}\ndisplay_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(findInHouse),\"yellow\")\ndisplay_notice(inHouse.substr(2),\"yellow\");"}],"text":"cdb house (.*)"},{"type":"alias","name":"cdb stats","enabled":true,"id":10,"matching":"begins","whole_words":true,"case_sensitive":true,"prefix_suffix":true,"actions":[{"action":"script","script":"var characterServerList = get_variable(\"characterDB\");\n\nvar cities = [];\nvar i = 0;\n\nfor(var key in characterServerList) {\n    if(characterServerList[key].city) {\n\t\tcities.push(characterServerList[key].city);\n    \ti++;\n\t}\n}\ncities = [...new Set(cities)];\n\nconsole.log(cities);\n\ncities.forEach(function(element) {\n  \tvar inCity = \"\";\n\tvar i = 0;\n\n\tfor(var key in characterServerList) {\n    \tif(characterServerList[key].city == element) {\n        \tinCity = inCity + \", \" + characterServerList[key].name;\n       \t\ti++;\n    \t}\n\t}\n\tdisplay_notice(\"Tracking \" + i + \" Adventurers in \" + fixCaps(element),\"yellow\")\n\tdisplay_notice(inCity.substr(2),\"yellow\");\n});"}],"text":"cdb stats"}]}